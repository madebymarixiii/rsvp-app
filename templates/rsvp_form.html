<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RSVP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="rsvp-page {{ 'embed' if embed else '' }}" data-theme="{{ theme or 'light' }}">
  <div class="container rsvp-wrap">
    <div class="rsvp-shell">

      <form method="post" class="rsvp-form">

        <!-- ✅ IMPORTANT: keeps token for Safari iframe (no cookies needed) -->
        <input type="hidden" name="t" value="{{ token or request.args.get('t','') }}">

        <label>WILL YOU ATTEND?</label>
        <select name="attending">
          <option value="yes" {% if existing_attending=='yes' %}selected{% endif %}>Yes, I will attend</option>
          <option value="no"  {% if existing_attending=='no'  %}selected{% endif %}>No, I can’t attend</option>
        </select>

        <label>DIETARY REQUESTS</label>
        <textarea name="dietary" placeholder="Allergies, restrictions, etc.">{{ existing_dietary }}</textarea>

        {% if extra_count > 0 %}
          <div class="rsvp-help" style="margin-top:10px;">
            You have {{ seats }} reserved seat(s). Please enter the other attendee name(s).
          </div>

          <label>NAME</label>
          <input
            name="main_name"
            placeholder="{{ guest.first_name }} {{ guest.last_name }}"
            value="{{ (existing_attendees[0] if existing_attendees and existing_attendees|length>0 else '') }}"
          >

          {% for i in range(extra_count) %}
            <label>ATTENDEE {{ i+2 }}</label>
            <input
              name="attendee_{{ i+2 }}"
              placeholder="Full name"
              value="{{ existing_attendees[i+1] if existing_attendees and existing_attendees|length>(i+1) else '' }}"
            >
          {% endfor %}
        {% endif %}

        {% if questions %}
          {% for q in questions %}
            <label>{{ q.label|upper }}</label>

            {% if q.field_type == 'textarea' %}
              <textarea name="q_{{ q.id }}">{{ existing_answers.get(q.label,'') }}</textarea>
            {% elif q.field_type == 'select' %}
              <select name="q_{{ q.id }}">
                <option value="">Select...</option>
                {% for opt in q.options %}
                  <option value="{{ opt }}" {% if existing_answers.get(q.label,'')==opt %}selected{% endif %}>{{ opt }}</option>
                {% endfor %}
              </select>
            {% else %}
              <input name="q_{{ q.id }}" value="{{ existing_answers.get(q.label,'') }}">
            {% endif %}
          {% endfor %}
        {% endif %}

        <button type="submit" class="rsvp-btn">SUBMIT</button>

        <div class="rsvp-help">
          You can come back anytime and update your RSVP.
        </div>

      </form>

      <!-- ✅ SUCCESS message WITHOUT flash/session -->
      {% if saved %}
        <div class="rsvp-success">
          Thank you! Your RSVP has been saved.
        </div>
      {% endif %}

    </div>
  </div>
</body>
</html>
