<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>RSVP</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body class="rsvp-page {{ 'embed' if embed else '' }}">
  <div class="container rsvp-wrap">
    <div class="rsvp-shell">

      {% if locked %}
        <div class="rsvp-note">Too many attempts. Try again in about {{ mins }} minute(s).</div>
      {% endif %}

      {% if error %}
        <div class="rsvp-note">{{ error }}</div>
      {% endif %}

      <form method="post" class="rsvp-form" autocomplete="on">
        <div class="rsvp-grid2">
          <div style="position:relative;">
            <label>FIRST NAME</label>
            <input
              id="firstName"
              name="first_name"
              autocomplete="given-name"
              required
              value="{{ first_name or '' }}"
            >

            <!-- ✅ Suggestions dropdown -->
            <div class="rsvp-suggest" id="suggestBox" style="display:none;"></div>
          </div>

          <div>
            <label>LAST NAME</label>
            <input
              id="lastName"
              name="last_name"
              autocomplete="family-name"
              required
              value="{{ last_name or '' }}"
            >
          </div>
        </div>

        <button type="submit" class="rsvp-btn">CONTINUE</button>

        <div class="rsvp-help">
          If you can’t find your name, please contact the couple.
        </div>

        {% if not locked %}
          <div class="rsvp-help rsvp-attempts">
            Attempts left: {{ attempts_left }}
          </div>
        {% endif %}
      </form>

    </div>
  </div>

  <script>
    (function(){
      const slug = "{{ client.slug }}";
      const first = document.getElementById("firstName");
      const last  = document.getElementById("lastName");
      const box   = document.getElementById("suggestBox");

      let timer = null;

      function hide(){
        box.style.display = "none";
        box.innerHTML = "";
      }

      function render(items){
        if(!items || items.length === 0){ hide(); return; }
        box.innerHTML = items.map(it =>
          `<button type="button" class="rsvp-suggest-item" data-first="${it.first_name}">
            ${it.label}
          </button>`
        ).join("");
        box.style.display = "block";
      }

      first.addEventListener("input", () => {
        clearTimeout(timer);
        const q = (first.value || "").trim();
        if(q.length < 2){ hide(); return; }

        timer = setTimeout(async () => {
          try{
            const res = await fetch(`/rsvp/${encodeURIComponent(slug)}/suggest?q=${encodeURIComponent(q)}`, {
              credentials: "omit" // no cookies needed
            });
            const data = await res.json();
            render(data.items || []);
          }catch(e){
            hide();
          }
        }, 220);
      });

      box.addEventListener("click", (e) => {
        const btn = e.target.closest(".rsvp-suggest-item");
        if(!btn) return;
        first.value = btn.dataset.first || "";
        hide();
        last.focus();
      });

      document.addEventListener("click", (e) => {
        if(e.target === first || box.contains(e.target)) return;
        hide();
      });

      // optional: hide when typing last name
      last.addEventListener("input", hide);
    })();
  </script>
</body>
</html>
